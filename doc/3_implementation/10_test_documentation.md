# 10. テストドキュメント

## 10.1. テスト計画書

### 概要

本テスト計画書は、Project Progress DB システムの品質保証のために実施するテストの方針、スコープ、スケジュール、体制を定義する。

### テスト対象システム

- **システム名**: Project Progress DB
- **概要**: 会議議事録から自動でタスク・リスク・決定事項を抽出し、プロジェクト進捗を管理するシステム
- **対象コンポーネント**:
  - Frontend（Next.js）
  - API Service（FastAPI）
  - Worker Service（Flask + Pub/Sub）
  - データベース（BigQuery）
  - AI処理（Vertex AI Gemini）

### テストレベル

| レベル | 説明 | 担当 |
|--------|------|------|
| **単体テスト** | 個々の関数・メソッドの正常動作確認 | 開発者 |
| **統合テスト** | コンポーネント間の連携確認 | 開発者 |
| **システムテスト** | 全体フローの動作確認 | QA |
| **E2Eテスト** | 本番環境でのエンドツーエンド確認 | QA |

### テスト環境

| 環境 | 用途 | 構成 |
|------|------|------|
| **ローカル環境** | 単体・統合テスト | Docker Compose, ローカルDB |
| **ステージング環境** | システムテスト | Cloud Run（ステージング） |
| **本番環境** | E2Eテスト（限定的） | Cloud Run（本番） |

### テストツール

| ツール | 用途 |
|--------|------|
| **pytest** | Pythonバックエンドの単体・統合テスト |
| **httpx** | FastAPI非同期テストクライアント |
| **Jest** | フロントエンドコンポーネントテスト |
| **Python E2E Script** | 本番API統合確認 |

### 合格基準

- 単体テスト: カバレッジ 80% 以上
- 統合テスト: 主要フロー全てPASS
- E2Eテスト: 主要ユースケース全てPASS
- パフォーマンス: ダッシュボードロード 2秒以内

---

## 10.2. テスト仕様書

### 単体テスト仕様

#### API Service

| テストID | テスト対象 | テスト観点 |
|----------|-----------|-----------|
| UT-API-001 | `/` ヘルスチェック | 正常レスポンス確認 |
| UT-API-002 | `/upload/` | 認証なしでの拒否確認 |
| UT-API-003 | `/upload/` | 認証ありでのファイルアップロード |
| UT-API-004 | `/projects/` | プロジェクト一覧取得 |
| UT-API-005 | `/tasks/` | タスク一覧取得 |
| UT-API-006 | `/tasks/` | フィルタ機能（owner, status） |
| UT-API-007 | `/risks/` | リスク一覧取得 |
| UT-API-008 | `/risks/` | リスクレベルフィルタ |
| UT-API-009 | `/export/csv/tasks` | CSVエクスポート生成 |
| UT-API-010 | JWT認証 | トークン生成・検証 |
| UT-API-011 | JWT認証 | 期限切れトークン拒否 |
| UT-API-012 | OAuth | Google OAuthフロー |

#### Worker Service

| テストID | テスト対象 | テスト観点 |
|----------|-----------|-----------|
| UT-WRK-001 | Pub/Sub受信 | メッセージパース |
| UT-WRK-002 | GCS読み込み | ファイルダウンロード |
| UT-WRK-003 | Gemini呼び出し | AIレスポンスパース |
| UT-WRK-004 | 日付パース | 相対日付の絶対日付変換 |
| UT-WRK-005 | BigQuery書き込み | データ挿入 |

### 統合テスト仕様

| テストID | テスト対象 | テスト観点 |
|----------|-----------|-----------|
| IT-001 | API→GCS | ファイルアップロード連携 |
| IT-002 | API→Pub/Sub | イベント発行 |
| IT-003 | API→BigQuery | クエリ・挿入 |
| IT-004 | Worker→GCS | ファイル読み取り |
| IT-005 | Worker→Vertex AI | AI処理連携 |
| IT-006 | Worker→BigQuery | 抽出データ保存 |
| IT-007 | Frontend→API | REST API通信 |

### E2Eテスト仕様

| テストID | シナリオ | 前提条件 |
|----------|----------|----------|
| E2E-001 | ファイルアップロード→AI処理→データ表示 | 認証済みユーザー |
| E2E-002 | プロジェクト一覧表示 | データ存在 |
| E2E-003 | タスクフィルタリング | タスク存在 |
| E2E-004 | CSVエクスポート | データ存在 |
| E2E-005 | ログイン→ダッシュボード表示 | 未認証状態 |

---

## 10.3. テストケース

### 単体テストケース

#### UT-API-001: ヘルスチェック

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-001 |
| **テスト名** | ヘルスチェックエンドポイント |
| **前提条件** | APIサーバーが起動していること |
| **テスト手順** | 1. `GET /` リクエストを送信 |
| **入力データ** | なし |
| **期待結果** | ステータス: 200, Body: `{"message": "Project Progress DB API is running", "version": "1.0.0"}` |
| **実装ファイル** | `backend/api/tests/test_main.py::test_health_check` |

#### UT-API-002: 認証なしアップロード拒否

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-002 |
| **テスト名** | 認証なしでのアップロード拒否 |
| **前提条件** | APIサーバーが起動していること |
| **テスト手順** | 1. 認証ヘッダーなしで `POST /upload/` リクエスト |
| **入力データ** | なし |
| **期待結果** | ステータス: 401 Unauthorized |
| **実装ファイル** | `backend/api/tests/test_main.py::test_upload_missing_auth` |

#### UT-API-003: 認証付きアップロード

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-003 |
| **テスト名** | 認証付きファイルアップロード |
| **前提条件** | 有効なJWTトークン |
| **テスト手順** | 1. JWTトークンを生成<br>2. Authorization ヘッダーを設定<br>3. ファイルをmultipart/form-dataでPOST |
| **入力データ** | ファイル: .md/.txt, meeting_date: YYYY-MM-DD |
| **期待結果** | ステータス: 200, Body: `{"meeting_id": "...", "status": "PENDING"}` |

#### UT-API-004: プロジェクト一覧取得

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-004 |
| **テスト名** | プロジェクト一覧の取得 |
| **前提条件** | 認証済み、プロジェクトデータ存在 |
| **テスト手順** | 1. `GET /projects/` リクエスト |
| **入力データ** | Authorization: Bearer {token} |
| **期待結果** | ステータス: 200, Body: プロジェクト配列 `[{"project_id": "...", "project_name": "..."}]` |

#### UT-API-005: タスク一覧取得

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-005 |
| **テスト名** | タスク一覧の取得 |
| **前提条件** | 認証済み、タスクデータ存在 |
| **テスト手順** | 1. `GET /tasks/` リクエスト |
| **入力データ** | Authorization: Bearer {token} |
| **期待結果** | ステータス: 200, Body: タスク配列 |

#### UT-API-006: タスクフィルタリング

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-006 |
| **テスト名** | タスクのフィルタ機能 |
| **前提条件** | 認証済み、複数タスク存在 |
| **テスト手順** | 1. `GET /tasks/?status=IN_PROGRESS` |
| **入力データ** | クエリパラメータ: status, owner, project_id |
| **期待結果** | フィルタ条件に合致するタスクのみ返却 |

#### UT-API-007: リスク一覧取得

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-007 |
| **テスト名** | リスク一覧の取得 |
| **前提条件** | 認証済み |
| **テスト手順** | 1. `GET /risks/` リクエスト |
| **期待結果** | ステータス: 200, リスク配列 |

#### UT-API-008: リスクレベルフィルタ

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-008 |
| **テスト名** | リスクレベルでのフィルタ |
| **前提条件** | 認証済み、複数リスク存在 |
| **テスト手順** | 1. `GET /risks/?level=HIGH` |
| **期待結果** | HIGHレベルのリスクのみ返却 |

#### UT-API-009: CSVエクスポート

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-009 |
| **テスト名** | タスクCSVエクスポート |
| **前提条件** | 認証済み、タスク存在 |
| **テスト手順** | 1. `GET /export/csv/tasks` |
| **期待結果** | Content-Type: text/csv, CSVファイルダウンロード |

#### UT-API-010: JWTトークン生成・検証

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-010 |
| **テスト名** | JWTトークンの生成と検証 |
| **前提条件** | JWT_SECRET_KEY設定済み |
| **テスト手順** | 1. ユーザー情報でトークン生成<br>2. トークンをデコード<br>3. クレーム確認 |
| **期待結果** | トークンが正しく生成・検証される |

#### UT-API-011: 期限切れトークン拒否

| 項目 | 内容 |
|------|------|
| **テストID** | UT-API-011 |
| **テスト名** | 期限切れトークンの拒否 |
| **前提条件** | 期限切れのトークン |
| **テスト手順** | 1. 期限切れトークンでリクエスト |
| **期待結果** | ステータス: 401, エラーメッセージ |

#### UT-WRK-004: 日付パース

| 項目 | 内容 |
|------|------|
| **テストID** | UT-WRK-004 |
| **テスト名** | 相対日付の絶対日付変換 |
| **前提条件** | 会議日付設定 |
| **テスト手順** | 1. 「来週金曜日」を入力<br>2. 絶対日付に変換 |
| **入力データ** | 会議日: 2024-12-01, テキスト: "next Friday" |
| **期待結果** | 2024-12-06（次の金曜日） |

---

### E2Eテストケース

#### E2E-001: ファイルアップロード→AI処理→データ表示

| 項目 | 内容 |
|------|------|
| **テストID** | E2E-001 |
| **テスト名** | 完全なアップロード・解析フロー |
| **前提条件** | 本番環境稼働中、認証情報取得可能 |
| **テスト手順** | 1. JWTトークン生成<br>2. ヘルスチェック確認<br>3. テストファイル作成<br>4. ファイルアップロード<br>5. AI処理完了を待機（最大60秒）<br>6. プロジェクト一覧でデータ確認<br>7. タスク一覧でデータ確認 |
| **入力データ** | 会議議事録（マークダウン形式） |
| **期待結果** | プロジェクト「Project Alpha」とタスク「Complete E2E testing」が抽出・表示される |
| **実装ファイル** | `e2e_test.py` |

#### E2E-002: プロジェクト一覧表示

| 項目 | 内容 |
|------|------|
| **テストID** | E2E-002 |
| **テスト名** | プロジェクト一覧の表示 |
| **前提条件** | 認証済み、プロジェクトデータ存在 |
| **テスト手順** | 1. ログイン<br>2. ダッシュボードへ遷移<br>3. プロジェクト一覧を確認 |
| **期待結果** | プロジェクト名、タスク数、リスク数が表示される |

#### E2E-003: タスクフィルタリング

| 項目 | 内容 |
|------|------|
| **テストID** | E2E-003 |
| **テスト名** | タスク表示とフィルタ機能 |
| **前提条件** | 複数タスクが存在 |
| **テスト手順** | 1. タスク一覧を表示<br>2. ステータスフィルタ適用<br>3. オーナーフィルタ適用 |
| **期待結果** | フィルタ条件に合致するタスクのみ表示 |

#### E2E-004: CSVエクスポート

| 項目 | 内容 |
|------|------|
| **テストID** | E2E-004 |
| **テスト名** | データのCSVエクスポート |
| **前提条件** | エクスポート対象データ存在 |
| **テスト手順** | 1. ダッシュボードで「Export」クリック<br>2. CSVファイルのダウンロード確認 |
| **期待結果** | 正しいカラム構成のCSVファイル取得 |

#### E2E-005: ログインフロー

| 項目 | 内容 |
|------|------|
| **テストID** | E2E-005 |
| **テスト名** | Google OAuthログイン |
| **前提条件** | 未認証状態 |
| **テスト手順** | 1. トップページへアクセス<br>2. ログインボタンをクリック<br>3. Google認証実施<br>4. ダッシュボードへリダイレクト確認 |
| **期待結果** | 認証後、ダッシュボードが表示される |

---

### 異常系テストケース

#### ERR-001: 不正なファイル形式

| 項目 | 内容 |
|------|------|
| **テストID** | ERR-001 |
| **テスト名** | サポート外ファイル形式の拒否 |
| **テスト手順** | 1. .pdf ファイルをアップロード |
| **期待結果** | エラーメッセージ「Unsupported file format」 |

#### ERR-002: ファイルサイズ超過

| 項目 | 内容 |
|------|------|
| **テストID** | ERR-002 |
| **テスト名** | 大容量ファイルの拒否 |
| **テスト手順** | 1. 10MB超のファイルをアップロード |
| **期待結果** | エラーメッセージ「File too large」 |

#### ERR-003: AI処理失敗

| 項目 | 内容 |
|------|------|
| **テストID** | ERR-003 |
| **テスト名** | AI処理エラーハンドリング |
| **前提条件** | Vertex AI一時障害 |
| **期待結果** | Meeting status: ERROR, ユーザーへ通知 |

#### ERR-004: BigQuery書き込み失敗

| 項目 | 内容 |
|------|------|
| **テストID** | ERR-004 |
| **テスト名** | データ保存エラー |
| **前提条件** | BigQuery一時障害 |
| **期待結果** | リトライ実行、最終的にエラー通知 |

---

## テスト実行コマンド

### 単体テスト（バックエンド）

```bash
# APIサービスのテスト
cd backend/api
pytest tests/ -v

# カバレッジ付き
pytest tests/ --cov=. --cov-report=html
```

### E2Eテスト

```bash
# 本番環境E2Eテスト
python e2e_test.py
```

### Cloud Build スモークテスト

```bash
# cloudbuild.yaml内で自動実行
# - フロントエンドヘルスチェック
# - APIヘルスチェック
curl -f https://project-progress-frontend-prod-xxxx.run.app/
curl -f https://project-progress-api-prod-xxxx.run.app/
```
